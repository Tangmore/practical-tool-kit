#### å…³äºŽ Event LoopðŸ”„

### â±ï¸ æ‰§è¡Œæ ˆ

å½“ javascript ä»£ç æ‰§è¡Œçš„æ—¶å€™ä¼šå°†ä¸åŒçš„å˜é‡å­˜äºŽå†…å­˜ä¸­çš„ä¸åŒä½ç½®ï¼šå †ï¼ˆheapï¼‰å’Œæ ˆï¼ˆstackï¼‰ä¸­æ¥åŠ ä»¥åŒºåˆ†ã€‚å…¶ä¸­ï¼Œå †é‡Œå­˜æ”¾ç€ä¸€äº›å¯¹è±¡ã€‚è€Œæ ˆä¸­åˆ™å­˜æ”¾ç€ä¸€äº›åŸºç¡€ç±»åž‹å˜é‡ä»¥åŠå¯¹è±¡çš„æŒ‡é’ˆã€‚ ä½†æ˜¯æˆ‘ä»¬è¿™é‡Œè¯´çš„æ‰§è¡Œæ ˆå’Œä¸Šé¢è¿™ä¸ªæ ˆçš„æ„ä¹‰å´æœ‰äº›ä¸åŒã€‚

æˆ‘ä»¬çŸ¥é“ï¼Œå½“æˆ‘ä»¬è°ƒç”¨ä¸€ä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œjs ä¼šç”Ÿæˆä¸€ä¸ªä¸Žè¿™ä¸ªæ–¹æ³•å¯¹åº”çš„æ‰§è¡ŒçŽ¯å¢ƒï¼ˆcontextï¼‰ï¼Œåˆå«æ‰§è¡Œä¸Šä¸‹æ–‡ã€‚è¿™ä¸ªæ‰§è¡ŒçŽ¯å¢ƒä¸­å­˜åœ¨ç€è¿™ä¸ªæ–¹æ³•çš„ç§æœ‰ä½œç”¨åŸŸï¼Œä¸Šå±‚ä½œç”¨åŸŸçš„æŒ‡å‘ï¼Œæ–¹æ³•çš„å‚æ•°ï¼Œè¿™ä¸ªä½œç”¨åŸŸä¸­å®šä¹‰çš„å˜é‡ä»¥åŠè¿™ä¸ªä½œç”¨åŸŸçš„ this å¯¹è±¡ã€‚ è€Œå½“ä¸€ç³»åˆ—æ–¹æ³•è¢«ä¾æ¬¡è°ƒç”¨çš„æ—¶å€™ï¼Œå› ä¸º js æ˜¯å•çº¿ç¨‹çš„ï¼ŒåŒä¸€æ—¶é—´åªèƒ½æ‰§è¡Œä¸€ä¸ªæ–¹æ³•ï¼ŒäºŽæ˜¯è¿™äº›æ–¹æ³•è¢«æŽ’é˜Ÿåœ¨ä¸€ä¸ªå•ç‹¬çš„åœ°æ–¹ã€‚è¿™ä¸ªåœ°æ–¹è¢«ç§°ä¸ºæ‰§è¡Œæ ˆã€‚

å½“ä¸€ä¸ªè„šæœ¬ç¬¬ä¸€æ¬¡æ‰§è¡Œçš„æ—¶å€™ï¼Œjs å¼•æ“Žä¼šè§£æžè¿™æ®µä»£ç ï¼Œå¹¶å°†å…¶ä¸­çš„åŒæ­¥ä»£ç æŒ‰ç…§æ‰§è¡Œé¡ºåºåŠ å…¥æ‰§è¡Œæ ˆä¸­ï¼Œç„¶åŽä»Žå¤´å¼€å§‹æ‰§è¡Œã€‚å¦‚æžœå½“å‰æ‰§è¡Œçš„æ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œé‚£ä¹ˆ js ä¼šå‘æ‰§è¡Œæ ˆä¸­æ·»åŠ è¿™ä¸ªæ–¹æ³•çš„æ‰§è¡ŒçŽ¯å¢ƒï¼Œç„¶åŽè¿›å…¥è¿™ä¸ªæ‰§è¡ŒçŽ¯å¢ƒç»§ç»­æ‰§è¡Œå…¶ä¸­çš„ä»£ç ã€‚å½“è¿™ä¸ªæ‰§è¡ŒçŽ¯å¢ƒä¸­çš„ä»£ç  æ‰§è¡Œå®Œæ¯•å¹¶è¿”å›žç»“æžœåŽï¼Œjs ä¼šé€€å‡ºè¿™ä¸ªæ‰§è¡ŒçŽ¯å¢ƒå¹¶æŠŠè¿™ä¸ªæ‰§è¡ŒçŽ¯å¢ƒé”€æ¯ï¼Œå›žåˆ°ä¸Šä¸€ä¸ªæ–¹æ³•çš„æ‰§è¡ŒçŽ¯å¢ƒã€‚è¿™ä¸ªè¿‡ç¨‹åå¤è¿›è¡Œï¼Œç›´åˆ°æ‰§è¡Œæ ˆä¸­çš„ä»£ç å…¨éƒ¨æ‰§è¡Œå®Œæ¯•ã€‚

### ðŸ“š ä»»åŠ¡é˜Ÿåˆ—

js å¼•æ“Žé‡åˆ°ä¸€ä¸ªå¼‚æ­¥äº‹ä»¶åŽå¹¶ä¸ä¼šä¸€ç›´ç­‰å¾…å…¶è¿”å›žç»“æžœï¼Œè€Œæ˜¯ä¼šå°†è¿™ä¸ªäº‹ä»¶æŒ‚èµ·ï¼Œç»§ç»­æ‰§è¡Œæ‰§è¡Œæ ˆä¸­çš„å…¶ä»–ä»»åŠ¡ã€‚å½“ä¸€ä¸ªå¼‚æ­¥äº‹ä»¶è¿”å›žç»“æžœåŽï¼Œjs ä¼šå°†è¿™ä¸ªäº‹ä»¶åŠ å…¥ä¸Žå½“å‰æ‰§è¡Œæ ˆä¸åŒçš„å¦ä¸€ä¸ªé˜Ÿåˆ—ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºäº‹ä»¶é˜Ÿåˆ—ã€‚è€Œæ ¹æ®å¼‚æ­¥äº‹ä»¶çš„ç±»åž‹ï¼Œäº‹ä»¶å®žé™…ä¸Šä¼šè¢«å¯¹åº”çš„å®ä»»åŠ¡é˜Ÿåˆ—æˆ–è€…å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­åŽ»ã€‚

### ðŸ“š äº‹ä»¶å¾ªçŽ¯

è¢«æ”¾å…¥äº‹ä»¶é˜Ÿåˆ—ä¸ä¼šç«‹åˆ»æ‰§è¡Œå…¶å›žè°ƒï¼Œè€Œæ˜¯ç­‰å¾…å½“å‰æ‰§è¡Œæ ˆä¸­çš„æ‰€æœ‰ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæ¯•ï¼Œ ä¸»çº¿ç¨‹å¤„äºŽé—²ç½®çŠ¶æ€æ—¶ï¼Œä¸»çº¿ç¨‹ä¼šå…ˆæŸ¥çœ‹å¾®ä»»åŠ¡é˜Ÿåˆ—æ˜¯å¦æœ‰äº‹ä»¶å­˜åœ¨ã€‚å¦‚æžœæœ‰ï¼Œåˆ™ä¼šä¾æ¬¡æ‰§è¡Œé˜Ÿåˆ—ä¸­äº‹ä»¶å¯¹åº”çš„å›žè°ƒï¼Œç›´åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºï¼Œç„¶åŽåŽ»å®ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºæœ€å‰é¢çš„ä¸€ä¸ªäº‹ä»¶ï¼ŒæŠŠå¯¹åº”çš„å›žè°ƒåŠ å…¥å½“å‰æ‰§è¡Œæ ˆï¼Œå¦‚æ­¤åå¤ï¼Œè¿™æ ·å°±å½¢æˆäº†ä¸€ä¸ªæ— é™çš„å¾ªçŽ¯ã€‚

### ðŸ§ª éªŒè¯ä»£ç ï¼ˆé‡è¦ï¼ï¼‰

```javascript
console.log("1. è„šæœ¬å¼€å§‹ï¼ˆå®ä»»åŠ¡ï¼‰");

setTimeout(() => console.log("6. setTimeoutï¼ˆå®ä»»åŠ¡ï¼‰"), 0);

Promise.resolve()
  .then(() => console.log("3. Promiseå¾®ä»»åŠ¡1"))
  .then(() => console.log("5. Promiseå¾®ä»»åŠ¡2"));

requestAnimationFrame(() => console.log("4. rAFå›žè°ƒ"));

console.log("2. è„šæœ¬ç»“æŸï¼ˆå®ä»»åŠ¡ï¼‰");
```

**æ‰§è¡Œé¡ºåº**:

1. `1. è„šæœ¬å¼€å§‹ï¼ˆå®ä»»åŠ¡ï¼‰`
2. `2. è„šæœ¬ç»“æŸï¼ˆå®ä»»åŠ¡ï¼‰`
3. `3. Promiseå¾®ä»»åŠ¡1`
4. `5. Promiseå¾®ä»»åŠ¡2` (æ³¨æ„è¿™é‡Œå…ˆæ‰§è¡Œäº†é“¾å¼è°ƒç”¨çš„å¾®ä»»åŠ¡)
5. `4. rAFå›žè°ƒ` (åœ¨å¾®ä»»åŠ¡ä¹‹åŽï¼Œæ¸²æŸ“å‰æ‰§è¡Œ)
6. `6. setTimeoutï¼ˆå®ä»»åŠ¡ï¼‰`(ä¸‹ä¸€è½®äº‹ä»¶å¾ªçŽ¯)

### â— å…³é”®è¦ç‚¹

1. **å¾®ä»»åŠ¡çš„è¿žé”ååº”**ï¼š

```javascript
Promise.resolve()
  .then(() => {
    console.log("å¾®ä»»åŠ¡1");
    Promise.resolve().then(() => console.log("åµŒå¥—å¾®ä»»åŠ¡"));
  })
  .then(() => console.log("å¾®ä»»åŠ¡2"));
```

è¾“å‡ºé¡ºåºï¼š

- å¾®ä»»åŠ¡ 1
- åµŒå¥—å¾®ä»»åŠ¡
- å¾®ä»»åŠ¡ 2

### ç¤ºä¾‹ä»£ç æ¼”ç¤º

```javascript
console.log("1"); // åŒæ­¥ä»»åŠ¡

setTimeout(() => {
  console.log("2"); // å®ä»»åŠ¡
}, 0);

Promise.resolve()
  .then(() => {
    console.log("3"); // å¾®ä»»åŠ¡
  })
  .then(() => {
    console.log("4"); // å¾®ä»»åŠ¡
  });

console.log("5"); // åŒæ­¥ä»»åŠ¡

// è¾“å‡ºé¡ºåºï¼š1, 5, 3, 4, 2
```

```js
console.log("1");

setTimeout(() => {
  console.log("2");
  Promise.resolve().then(() => console.log("3"));
}, 0);

Promise.resolve().then(() => {
  console.log("4");
  setTimeout(() => console.log("5"), 0);
});

console.log("6");

// è¾“å‡ºé¡ºåºï¼š1 â†’ 6 â†’ 4 â†’ 2 â†’ 3 â†’ 5
// æ‰§è¡Œè¿‡ç¨‹è§£æžï¼š
// åŒæ­¥ä»»åŠ¡ï¼š1ã€6
// å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼š4 (ä¼´éšå®ä»»åŠ¡5)
// å®ä»»åŠ¡é˜Ÿåˆ—ï¼š2 (ä¼´éšå¾®ä»»åŠ¡3)
// æœ€åŽå®ä»»åŠ¡ï¼š5
```

```js
console.log(1);

let promise = new Promise((resolve, reject) => {
  console.log(2);
  resolve("è¿™æ¬¡ä¸€å®š");
});

promise.then(
  (result) => {
    console.log("fulfilled:", result);
  },
  (reason) => {
    console.log("rejected:", reason);
  }
);

console.log(3);
// 1 2 3 fulfilled: è¿™æ¬¡ä¸€å®š
// é¦–å…ˆæ‰§è¡Œconsole.log(1)ï¼Œè¾“å‡º1
// æŽ¥ç€åˆ›å»ºpromiseå®žä¾‹ï¼Œè¾“å‡º2ï¼Œå› ä¸ºè¿™é‡Œä¾æ—§æ˜¯åŒæ­¥
// ç„¶åŽç¢°åˆ°resolveçš„æ—¶å€™ï¼Œä¿®æ”¹ç»“æžœå€¼
// åˆ°äº†promise.thenä¼šè¿›è¡Œå¼‚æ­¥æ“ä½œï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ éœ€è¦å…ˆæŠŠæ‰§è¡Œæ ˆçš„å†…å®¹æ¸…ç©ºï¼ŒäºŽæ˜¯å°±æ‰§è¡Œconsole.log(3)ï¼Œè¾“å‡º3
// æŽ¥ç€æ‰ä¼šæ‰§è¡Œpromise.thené‡Œé¢çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯æœ€åŽè¾“å‡ºâ€œfulfilled: è¿™æ¬¡ä¸€å®šâ€
```

```js
console.log(1);
let promise = new Promise((resolve, reject) => {
  console.log(2);
  setTimeout(() => {
    resolve("è¿™æ¬¡ä¸€å®š");
    console.log(4);
  });
});
promise.then(
  (result) => {
    console.log("fulfilled:", result);
  },
  (reason) => {
    console.log("rejected:", reason);
  }
);
console.log(3);
```

```js
async function async1() {
  console.log("1");
  await async2();
  console.log("2"); // å¾®ä»»åŠ¡
}
async function async2() {
  console.log("3");
}

setTimeout(() => console.log("4"), 0);
async1();
new Promise((res) => {
  console.log("5");
  res();
}).then(() => console.log("6"));
console.log("7");

// ç­”æ¡ˆï¼š1â†’3â†’5â†’7â†’2â†’6â†’4
```
