<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <script>
      // 请求并发控制
      async function parallelRequests(urls, maxConcurrent = 3) {
        const results = [];
        const executing = [];

        for (const url of urls) {
          const p = fetch(url).then((res) => res.json());
          results.push(p);

          const e = p.then(() => {
            executing.splice(executing.indexOf(e), 1);
          });
          executing.push(e);

          if (executing.length >= maxConcurrent) {
            await Promise.race(executing);
          }
        }

        return Promise.all(results);
      }
      // 异步任务队列
      class AsyncQueue {
        constructor() {
          this.queue = [];
          this.running = false;
        }

        add(task) {
          return new Promise((resolve, reject) => {
            this.queue.push({ task, resolve, reject });
            if (!this.running) this.next();
          });
        }

        next() {
          if (!this.queue.length) {
            this.running = false;
            return;
          }

          this.running = true;
          const { task, resolve, reject } = this.queue.shift();

          Promise.resolve(task())
            .then(resolve)
            .catch(reject)
            .finally(() => this.next());
        }
      }
    </script>
  </body>
</html>
